name: Code Quality Analysis

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  security-events: write

jobs:
  code-analysis:
    name: Analyze Code Quality
    runs-on: ubuntu-latest

    steps:
    # Étape 1 : Vérifier le code source
    - name: Checkout Code
      uses: actions/checkout@v4

    # Étape 2 : Configuration Java ou Node.js si nécessaire (ajustez selon votre projet)
    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        java-version: '17'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '16'

    # Étape 3 : Configuration SonarCloud
    - name: Set up SonarCloud CLI
      run: |
        curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.8.0.2856-linux.zip
        unzip sonar-scanner.zip -d $HOME/.sonar-scanner
        echo "$HOME/.sonar-scanner/bin" >> $GITHUB_PATH

    # Étape 4 : Analyse avec SonarCloud
    - name: Run SonarCloud Analysis
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        sonar-scanner \
          -Dsonar.projectKey=my_project_key \
          -Dsonar.organization=my_organization_key \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
          -Dsonar.sources=. \
          -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/test/** \
          -Dsonar.tests=src \
          -Dsonar.test.inclusions=**/*.spec.js,**/*.test.js \
          -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

    # Étape 5 : Générer un rapport SARIF (pour GitHub Security)
    - name: Upload SARIF Report
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: .scannerwork/report-task.txt

    # Étape 6 : Signaler les erreurs critiques (facultatif)
    - name: Fail on Quality Gate (optional)
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        curl -s -u ${{ secrets.SONAR_TOKEN }}: \
        "https://sonarcloud.io/api/qualitygates/project_status?projectKey=my_project_key" | \
        jq -e '.projectStatus.status == "ERROR"' && exit 1 || exit 0
